// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Plan {
  id        String   @id @default(uuid())
  key       String   @unique @db.VarChar(50)  // "BASIC", "PREMIUM"
  name      String   @db.VarChar(100)         // "Standart", "Premium"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  companies Company[]

  @@map("plans")
}

model Company {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  planId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  plan          Plan             @relation(fields: [planId], references: [id])
  users         User[]
  customers     Customer[]
  devices       Device[]
  appointments  Appointment[]
  payments      Payment[]
  notifications Notification[]

  @@index([planId])
  @@map("companies")
}

model User {
  id        String   @id @default(uuid())
  companyId String
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password") @db.VarChar(255)
  firstName    String   @db.VarChar(255)
  lastName     String   @db.VarChar(255)
  role         UserRole @default(STAFF)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company       Company        @relation(fields: [companyId], references: [id])
  refreshTokens RefreshToken[]

  @@index([companyId])
  @@map("users")
}

enum UserRole {
  ADMIN
  STAFF
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique @db.VarChar(500)
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model Customer {
  id         String    @id @default(uuid())
  companyId  String
  fullName   String    @db.VarChar(255)
  tcIdentity String?   @db.VarChar(11)
  birthDate  DateTime? @db.Date
  gender     Gender?
  heightCm   Int?
  phone      String?   @db.VarChar(20)
  notes      String?   @db.Text
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  totalDebt  Decimal   @default(0) @db.Decimal(10, 2)

  // Relations
  company      Company       @relation(fields: [companyId], references: [id])
  appointments Appointment[]
  payments     Payment[]

  @@unique([companyId, tcIdentity])
  @@index([companyId])
  @@map("customers")
}

enum Gender {
  male
  female
}

model Device {
  id          String   @id @default(uuid())
  companyId   String
  name        String   @db.VarChar(255)
  deviceCount Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company             Company             @relation(fields: [companyId], references: [id])
  appointmentDevices  AppointmentDevice[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("devices")
}


model Appointment {
  id         String            @id @default(uuid())
  companyId  String
  customerId String
  startTime  DateTime
  endTime    DateTime
  status     AppointmentStatus @default(scheduled)
  notes      String?           @db.Text
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  // Relations
  company  Company             @relation(fields: [companyId], references: [id])
  customer Customer            @relation(fields: [customerId], references: [id])
  devices  AppointmentDevice[]

  @@index([companyId])
  @@index([customerId])
  @@index([startTime])
  @@map("appointments")
}

enum AppointmentStatus {
  scheduled
  in_progress
  completed
  cancelled
}

model AppointmentDevice {
  id            String   @id @default(uuid())
  appointmentId String
  deviceId      String
  deviceName    String   @db.VarChar(255)
  sequence      Int      @default(1)
  startTime     DateTime
  endTime       DateTime
  createdAt     DateTime @default(now())

  // Relations
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  device      Device      @relation(fields: [deviceId], references: [id])

  @@index([appointmentId])
  @@index([deviceId])
  @@index([deviceName])
  @@index([startTime, endTime])
  @@map("appointment_devices")
}

model Payment {
  id          String      @id @default(uuid())
  companyId   String
  customerId  String
  amount      Decimal     @db.Decimal(10, 2)
  paymentType PaymentType
  paidAt      DateTime
  notes       String?     @db.Text
  createdAt   DateTime    @default(now())

  // Relations
  company  Company  @relation(fields: [companyId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])

  @@index([companyId])
  @@index([customerId])
  @@map("payments")
}

enum PaymentType {
  CASH
  INSTALLMENT
}

model Notification {
  id        String   @id @default(uuid())
  companyId String
  title     String   @db.VarChar(255)
  message   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  company Company @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@index([isRead])
  @@map("notifications")
}
