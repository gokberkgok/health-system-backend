// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Plan {
  id        String   @id @default(uuid())
  key       String   @unique @db.VarChar(50)  // "BASIC", "PREMIUM"
  name      String   @db.VarChar(100)         // "Standart", "Premium"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  companies Company[]

  @@map("plans")
}

model Company {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  planId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  plan           Plan             @relation(fields: [planId], references: [id])
  users          User[]
  customers      Customer[]
  devices        Device[]
  appointments   Appointment[]
  payments       Payment[]
  notifications  Notification[]
  refreshTokens  RefreshToken[]
  logs           Log[]

  @@index([planId])
  @@map("companies")
}

model User {
  id        String   @id @default(uuid())
  companyId String
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password") @db.VarChar(255)
  firstName    String   @db.VarChar(255)
  lastName     String   @db.VarChar(255)
  role         UserRole @default(STAFF)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company       Company        @relation(fields: [companyId], references: [id])
  refreshTokens RefreshToken[]
  logs          Log[]

  @@index([companyId])
  @@map("users")
}

enum UserRole {
  ADMIN
  STAFF
}

enum ClientType {
  WEB
  MOBILE
  ADMIN
}

enum LogAction {
  // üîê Authentication
  LOGIN
  LOGOUT
  REFRESH_TOKEN
  CHANGE_PASSWORD
  PASSWORD_RESET_REQUEST
  PASSWORD_RESET_COMPLETE
  
  // üö´ Authorization & Security
  FORBIDDEN_MOBILE_LOGIN
  UNAUTHORIZED_ACCESS
  PLAN_VIOLATION
  TOKEN_EXPIRED
  TOKEN_REVOKED
  INVALID_CREDENTIALS
  
  // üë• User Management
  CREATE_USER
  UPDATE_USER
  DELETE_USER
  ACTIVATE_USER
  DEACTIVATE_USER
  
  // üë§ Customer Management
  CREATE_CUSTOMER
  UPDATE_CUSTOMER
  DELETE_CUSTOMER
  VIEW_CUSTOMER
  
  // üìÖ Appointment Management
  CREATE_APPOINTMENT
  UPDATE_APPOINTMENT
  CANCEL_APPOINTMENT
  COMPLETE_APPOINTMENT
  MISS_APPOINTMENT
  VIEW_APPOINTMENT
  
  // üñ•Ô∏è Device Management
  CREATE_DEVICE
  UPDATE_DEVICE
  DELETE_DEVICE
  
  // üí∞ Payment Management
  CREATE_PAYMENT
  UPDATE_PAYMENT
  DELETE_PAYMENT
  REFUND_PAYMENT
  
  // üìä Reports & Analytics
  VIEW_REPORT
  EXPORT_REPORT
  
  // ‚öôÔ∏è System & Admin
  CHANGE_PLAN
  UPDATE_SETTINGS
  SYSTEM_ERROR
}

model RefreshToken {
  id         String     @id @default(uuid())
  userId     String
  companyId  String
  tokenHash  String     @unique @db.VarChar(500)
  clientType ClientType
  deviceId   String?    @db.VarChar(255)
  deviceName String?    @db.VarChar(255)
  ipAddress  String     @db.VarChar(45)
  userAgent  String     @db.Text
  expiresAt  DateTime
  createdAt  DateTime   @default(now())
  lastUsedAt DateTime   @default(now())
  revokedAt  DateTime?

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
  @@index([tokenHash])
  @@index([deviceId])
  @@map("refresh_tokens")
}

model Log {
  id         String     @id @default(uuid())
  companyId  String?
  userId     String?
  action     LogAction
  clientType ClientType
  ipAddress  String     @db.VarChar(45)
  deviceId   String?    @db.VarChar(255)
  userAgent  String     @db.Text
  metadata   Json?
  createdAt  DateTime   @default(now())

  // Relations
  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("logs")
}

model Customer {
  id         String    @id @default(uuid())
  companyId  String
  fullName   String    @db.VarChar(255)
  tcIdentity String?   @db.VarChar(11)
  birthDate  DateTime? @db.Date
  gender     Gender?
  heightCm   Int?
  phone      String?   @db.VarChar(20)
  notes      String?   @db.Text
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  totalDebt  Decimal   @default(0) @db.Decimal(10, 2)

  // Relations
  company      Company       @relation(fields: [companyId], references: [id])
  appointments Appointment[]
  payments     Payment[]

  @@unique([companyId, tcIdentity])
  @@index([companyId])
  @@map("customers")
}

enum Gender {
  male
  female
}

model Device {
  id          String   @id @default(uuid())
  companyId   String
  name        String   @db.VarChar(255)
  deviceCount Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company             Company             @relation(fields: [companyId], references: [id])
  appointmentDevices  AppointmentDevice[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("devices")
}


model Appointment {
  id         String            @id @default(uuid())
  companyId  String
  customerId String
  startTime  DateTime
  endTime    DateTime
  status     AppointmentStatus @default(scheduled)
  notes      String?           @db.Text
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  // Relations
  company  Company             @relation(fields: [companyId], references: [id])
  customer Customer            @relation(fields: [customerId], references: [id])
  devices  AppointmentDevice[]

  @@index([companyId])
  @@index([customerId])
  @@index([startTime])
  @@map("appointments")
}

enum AppointmentStatus {
  scheduled
  in_progress
  completed
  cancelled
}

model AppointmentDevice {
  id            String   @id @default(uuid())
  appointmentId String
  deviceId      String
  deviceName    String   @db.VarChar(255)
  sequence      Int      @default(1)
  startTime     DateTime
  endTime       DateTime
  createdAt     DateTime @default(now())

  // Relations
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  device      Device      @relation(fields: [deviceId], references: [id])

  @@index([appointmentId])
  @@index([deviceId])
  @@index([deviceName])
  @@index([startTime, endTime])
  @@map("appointment_devices")
}

model Payment {
  id          String      @id @default(uuid())
  companyId   String
  customerId  String
  amount      Decimal     @db.Decimal(10, 2)
  paymentType PaymentType
  paidAt      DateTime
  notes       String?     @db.Text
  createdAt   DateTime    @default(now())

  // Relations
  company  Company  @relation(fields: [companyId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])

  @@index([companyId])
  @@index([customerId])
  @@map("payments")
}

enum PaymentType {
  CASH
  INSTALLMENT
}

model Notification {
  id        String   @id @default(uuid())
  companyId String
  title     String   @db.VarChar(255)
  message   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  company Company @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@index([isRead])
  @@map("notifications")
}
